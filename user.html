<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF MAX PRO | TOURNAMENT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-app-pub-1799513996678934" crossorigin="anonymous"></script>

    <style>
        :root { --ff-gold: #ffcc00; --ff-cyan: #00f2ff; }
        body { background: #05080d; color: white; font-family: 'Rajdhani', sans-serif; overflow-x: hidden; }
        .ff-font { font-family: 'Orbitron', sans-serif; }
        .ff-card { background: linear-gradient(145deg, #101a26 0%, #050a0f 100%); border-left: 4px solid var(--ff-gold); clip-path: polygon(0 0, 100% 0, 100% 92%, 95% 100%, 0 100%); border-radius: 4px; position: relative; }
        .ff-input { background: #0a0f18; border: 1px solid #1e293b; color: white; padding: 14px; border-radius: 12px; width: 100%; outline: none; }
        .ff-btn { background: linear-gradient(90deg, #ffcc00 0%, #ff9500 100%); color: black; font-weight: 900; clip-path: polygon(8% 0, 100% 0, 92% 100%, 0 100%); cursor: pointer; transition: 0.3s; }
        .ff-btn:active { transform: scale(0.95); }
        .ad-banner { width: 100%; display: flex; justify-content: center; margin: 10px 0; min-height: 50px; background: rgba(0,0,0,0.3); }
        .hidden { display: none !important; }
    </style>
</head>
<body class="p-4 pb-24">

    <div class="ad-banner">
        <ins class="adsbygoogle"
             style="display:inline-block;width:320px;height:50px"
             data-ad-client="ca-app-pub-1799513996678934"
             data-ad-slot="9339921435"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>

    <div id="auth-section" class="max-w-md mx-auto mt-6">
        <div class="text-center mb-8">
            <img src="https://i.ibb.co/fdFmswW4/file-00000000f7547209ac262e991c2d8992.png" alt="Logo" class="w-20 h-20 mx-auto mb-4 rounded-2xl border-2 border-yellow-500 shadow-2xl">
            <h1 class="ff-font text-3xl font-black italic text-yellow-500 uppercase">Battle Hub</h1>
        </div>

        <div class="ff-card p-8 border border-white/5 shadow-2xl">
            <h2 id="auth-title" class="text-xl font-black mb-6 uppercase italic text-center text-cyan-400">Login</h2>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="EMAIL ADDRESS" class="ff-input">
                <input type="password" id="password" placeholder="PASSWORD" class="ff-input">
                <div id="signup-extra" class="hidden space-y-4">
                    <input type="text" id="ign-name" placeholder="GAME NAME (IGN)" class="ff-input">
                    <input type="number" id="ff-uid" placeholder="FREE FIRE UID" class="ff-input">
                </div>
                <button onclick="handleAuth()" id="auth-main-btn" class="ff-btn w-full py-4 text-sm mt-2 italic uppercase">Enter Lobby</button>
                <p class="text-center text-[10px] text-slate-500 font-bold mt-6 uppercase tracking-widest">
                    <span id="toggle-text">New Survivor?</span> 
                    <button onclick="toggleAuth()" class="text-cyan-400 underline">Switch Mode</button>
                </p>
            </div>
        </div>
    </div>

    <div id="main-section" class="max-w-md mx-auto hidden">
        <header class="flex justify-between items-center mb-6 px-1">
            <div class="flex items-center gap-3">
                <img src="https://i.ibb.co/fdFmswW4/file-00000000f7547209ac262e991c2d8992.png" class="w-12 h-12 rounded-xl border border-yellow-500">
                <div>
                    <h2 id="display-name" class="ff-font text-xl italic font-black text-white uppercase italic">...</h2>
                    <p id="display-uid" class="text-[9px] text-slate-500 font-bold tracking-widest">UID: 00000000</p>
                </div>
            </div>
            <button onclick="logout()" class="w-10 h-10 bg-red-600/10 text-red-500 rounded-full border border-red-500/30 flex items-center justify-center"><i class="fas fa-power-off"></i></button>
        </header>

        <div class="ff-card p-6 mb-8 flex justify-between items-center bg-black/40">
            <div>
                <p class="text-[9px] text-slate-500 font-bold mb-1 uppercase italic">Wallet Balance</p>
                <p class="text-4xl font-black ff-font italic">₹<span id="balance">0</span></p>
            </div>
            <div class="flex flex-col gap-2">
                <button onclick="openDeposit()" class="bg-cyan-500/10 border border-cyan-500/40 text-cyan-400 px-4 py-1.5 rounded-lg text-[9px] font-black italic">TOP UP</button>
                <button onclick="showWallet()" class="bg-yellow-500/10 border border-yellow-500/40 text-yellow-500 px-4 py-1.5 rounded-lg text-[9px] font-black italic">REDEEM</button>
            </div>
        </div>

        <div id="matches-list" class="space-y-6"></div>
    </div>

    <div id="wallet-page" class="max-w-md mx-auto hidden pt-4 text-center">
        <div class="ff-card p-10 mb-6 border-b-4 border-cyan-500">
            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1 italic">Withdrawal Balance</p>
            <p class="text-6xl font-black ff-font italic text-white">₹<span id="win-balance-display">0</span></p>
        </div>
        <div class="ff-card p-8 bg-black/40 text-left">
            <h3 class="ff-font text-xs text-yellow-500 italic mb-6 uppercase tracking-widest">Request Payment</h3>
            <input type="number" id="withdraw-amt" placeholder="AMT (₹20 - ₹500)" class="ff-input mb-4">
            <input type="text" id="withdraw-upi" placeholder="UPI ID (e.g. name@upi)" class="ff-input mb-6">
            <button onclick="requestWithdrawal()" class="ff-btn w-full py-5 text-sm italic uppercase">Process Withdrawal</button>
        </div>
        <button onclick="showLobby()" class="mt-8 text-cyan-400 font-bold text-xs uppercase underline">Back to Lobby</button>
    </div>

    <div class="fixed bottom-0 left-0 w-full z-40 bg-black/80 py-1">
        <div class="ad-banner">
            <ins class="adsbygoogle"
                 style="display:inline-block;width:320px;height:50px"
                 data-ad-client="ca-app-pub-1799513996678934"
                 data-ad-slot="9339921435"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>
    </div>

    <div id="deposit-modal" class="fixed inset-0 z-50 hidden bg-black/95 flex items-center justify-center p-6 text-center">
        <div class="w-full max-w-sm">
            <h2 class="ff-font text-2xl text-yellow-500 italic mb-4">RECHARGE WALLET</h2>
            <div class="p-3 bg-white rounded-3xl mb-6 mx-auto inline-block border-4 border-cyan-500 shadow-2xl">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=upi://pay?pa=ffritik@fam&pn=FF-Admin&cu=INR" alt="QR" class="rounded-2xl">
            </div>
            <p class="text-[10px] font-bold text-slate-400 mb-6">UPI ID: <span class="text-white">ffritik@fam</span></p>
            <input type="text" id="txn-id" placeholder="12-DIGIT TXN ID" class="ff-input text-center text-yellow-500 font-bold mb-6">
            <button onclick="submitDeposit()" class="ff-btn w-full py-5 text-sm italic uppercase">Confirm Payment</button>
            <button onclick="closeModal()" class="mt-6 text-slate-600 font-bold text-[9px] uppercase underline">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, increment, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAO75eGVJn68iFWcV5IzGEjFFS_GNl2d1g",
            authDomain: "ff-max-pro-tournament.firebaseapp.com",
            databaseURL: "https://ff-max-pro-tournament-default-rtdb.firebaseio.com",
            projectId: "ff-max-pro-tournament",
            storageBucket: "ff-max-pro-tournament.firebasestorage.app",
            messagingSenderId: "989952939821",
            appId: "1:989952939821:web:15286eaff9e3262ad925a4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let isSignupMode = false;
        let userData = null;

        // FIXED: Data Handling and Login Logic
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                const docSnap = await getDoc(doc(db, "users", user.uid));
                if(docSnap.exists()){
                    userData = docSnap.data();
                    document.getElementById('display-name').innerText = userData.name || "Survivor";
                    document.getElementById('display-uid').innerText = "UID: " + (userData.ff_uid || "000000");
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('main-section').classList.remove('hidden');
                    loadDashboard(user.uid);
                }
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('main-section').classList.add('hidden');
                document.getElementById('wallet-page').classList.add('hidden');
            }
        });

        function loadDashboard(uid) {
            onSnapshot(doc(db, "users", uid), (d) => {
                userData = d.data();
                document.getElementById('balance').innerText = userData.balance || 0;
                document.getElementById('win-balance-display').innerText = userData.balance || 0;
            });

            onSnapshot(collection(db, "matches"), (snap) => {
                const list = document.getElementById('matches-list');
                list.innerHTML = "";
                snap.forEach(mDoc => {
                    const m = mDoc.data();
                    const isJoined = userData.joinedMatches.includes(mDoc.id);
                    list.innerHTML += `
                        <div class="ff-card p-5 shadow-2xl">
                            <div class="flex items-center gap-3 mb-4">
                                <img src="https://i.ibb.co/fdFmswW4/file-00000000f7547209ac262e991c2d8992.png" class="w-10 h-10 rounded-lg border border-yellow-500">
                                <h4 class="ff-font text-base font-black italic uppercase">${m.title}</h4>
                            </div>
                            <div class="bg-black/60 p-4 rounded-xl mb-4 text-center border border-dashed border-slate-800">
                                ${isJoined ? `<p class="text-[11px] text-yellow-500 font-bold uppercase tracking-widest">ID: ${m.roomId} | PASS: ${m.pass}</p>` : `<p class="text-[9px] text-slate-600 uppercase italic">Join match to see room ID</p>`}
                            </div>
                            <div class="flex justify-between items-end">
                                <div><p class="text-[8px] text-slate-500 font-bold uppercase">Grand Prize</p><p class="text-xl font-black text-green-400 ff-font italic">₹${m.prize}</p></div>
                                <button onclick="${isJoined ? "" : `joinMatch('${mDoc.id}', ${m.fee})`}" class="ff-btn px-6 py-2.5 text-[10px] italic uppercase">${isJoined ? 'Joined' : `Join: ₹${m.fee}`}</button>
                            </div>
                        </div>`;
                });
            });
        }

        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if(!email || !pass) return alert("Fill all fields!");
            try {
                if(isSignupMode) {
                    const ign = document.getElementById('ign-name').value;
                    const ffid = document.getElementById('ff-uid').value;
                    if(!ign || !ffid) return alert("Fill FF Details!");
                    const res = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db, "users", res.user.uid), { name: ign, ff_uid: ffid, email, balance: 10, joinedMatches: [] });
                    alert("Welcome! ₹10 Signup Bonus Added.");
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch(e) { alert(e.message); }
        };

        window.requestWithdrawal = async () => {
            const amt = Number(document.getElementById('withdraw-amt').value);
            const upi = document.getElementById('withdraw-upi').value;
            if (amt < 20 || amt > 500) return alert("Min ₹20 | Max ₹500");
            if (userData.balance < amt) return alert("Low balance!");
            if (!upi.includes('@')) return alert("Enter valid UPI ID!");

            await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(-amt) });
            await addDoc(collection(db, "withdrawals"), { 
                uid: auth.currentUser.uid, 
                name: userData.name, 
                amount: amt, 
                upi: upi, 
                status: "pending", 
                createdAt: new Date() 
            });
            alert("Request Submitted! Expected in 24 hrs.");
            showLobby();
        };

        window.joinMatch = async (mid, fee) => {
            if(userData.balance < fee) return alert("Insufficient Balance!");
            if(confirm("Confirm entry for ₹" + fee + "?")) {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(-fee), joinedMatches: [...userData.joinedMatches, mid] });
                alert("Successfully Joined!");
            }
        };

        window.submitDeposit = async () => {
            const txid = document.getElementById('txn-id').value;
            if(txid.length < 10) return alert("Enter valid TXN ID!");
            await addDoc(collection(db, "deposits"), { uid: auth.currentUser.uid, name: userData.name, txnId: txid, status: "pending", createdAt: new Date() });
            alert("Verification pending (approx 30 mins)");
            closeModal();
        };

        window.toggleAuth = () => { isSignupMode = !isSignupMode; document.getElementById('auth-title').innerText = isSignupMode ? "Register Account" : "Login Lobby"; document.getElementById('signup-extra').classList.toggle('hidden'); };
        window.showWallet = () => { document.getElementById('main-section').classList.add('hidden'); document.getElementById('wallet-page').classList.remove('hidden'); window.scrollTo(0,0); };
        window.showLobby = () => { document.getElementById('main-section').classList.remove('hidden'); document.getElementById('wallet-page').classList.add('hidden'); };
        window.openDeposit = () => document.getElementById('deposit-modal').classList.remove('hidden');
        window.closeModal = () => document.getElementById('deposit-modal').classList.add('hidden');
        window.logout = () => signOut(auth);
    </script>
</body>
</html>